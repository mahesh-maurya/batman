THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){function e(t){if(t.visible!==!1){if(t instanceof THREE.Light)O.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Points){if(t.material.visible===!1)return;if(t.frustumCulled===!0&&G.intersectsObject(t)===!1)return;r(t)}else if(t instanceof THREE.Sprite){if(t.material.visible===!1)return;if(t.frustumCulled===!0&&G.intersectsSprite(t)===!1)return;r(t)}for(var i=t.children,n=0,o=i.length;o>n;n++)e(i[n])}}function r(e){p=i(),p.id=e.id,p.object=e,C.setFromMatrixPosition(e.matrixWorld),C.applyMatrix4(A),p.z=C.z,p.renderOrder=e.renderOrder,O.objects.push(p)}function t(e,r,t){var i=1/e.w;e.z*=i,e.z>=-1&&e.z<=1&&(y=s(),y.id=r.id,y.x=e.x*i,y.y=e.y*i,y.z=e.z,y.renderOrder=r.renderOrder,y.object=r,y.rotation=r.rotation,y.scale.x=r.scale.x*Math.abs(y.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),y.scale.y=r.scale.y*Math.abs(y.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),y.material=r.material,O.elements.push(y))}function i(){if(E===H){var e=new THREE.RenderableObject;return T.push(e),H++,E++,e}return T[E++]}function n(){if(h===w){var e=new THREE.RenderableVertex;return g.push(e),w++,h++,e}return g[h++]}function o(){if(f===M){var e=new THREE.RenderableFace;return S.push(e),M++,f++,e}return S[f++]}function a(){if(m===z){var e=new THREE.RenderableLine;return b.push(e),z++,m++,e}return b[m++]}function s(){if(x===j){var e=new THREE.RenderableSprite;return V.push(e),j++,x++,e}return V[x++]}function l(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function c(e,r){var t=0,i=1,n=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return n>=0&&o>=0&&a>=0&&s>=0?!0:0>n&&0>o||0>a&&0>s?!1:(0>n?t=Math.max(t,n/(n-o)):0>o&&(i=Math.min(i,n/(n-o))),0>a?t=Math.max(t,a/(a-s)):0>s&&(i=Math.min(i,a/(a-s))),t>i?!1:(e.lerp(r,t),r.lerp(e,1-i),!0))}var p,E,u,h,d,f,v,m,y,x,R,T=[],H=0,g=[],w=0,S=[],M=0,b=[],z=0,V=[],j=0,O={objects:[],lights:[],elements:[]},C=new THREE.Vector3,L=new THREE.Vector4,k=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),N=new THREE.Box3,W=new Array(3),B=new THREE.Matrix4,A=new THREE.Matrix4,F=new THREE.Matrix4,P=new THREE.Matrix3,G=new THREE.Frustum,D=new THREE.Vector4,I=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var U=function(){function e(e){T=e,H=T.material,w.getNormalMatrix(T.matrixWorld),m.length=0,y.length=0,x.length=0}function r(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(R),i.copy(t).applyMatrix4(A);var n=1/i.w;i.x*=n,i.y*=n,i.z*=n,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function t(e,t,i){u=n(),u.position.set(e,t,i),r(u)}function i(e,r,t){m.push(e,r,t)}function s(e,r,t){y.push(e,r,t)}function l(e,r){x.push(e,r)}function p(e,r,t){return e.visible===!0||r.visible===!0||t.visible===!0?!0:(W[0]=e.positionScreen,W[1]=r.positionScreen,W[2]=t.positionScreen,k.intersectsBox(N.setFromPoints(W)))}function E(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}function h(e,r){var t=g[e],i=g[r];t.positionScreen.copy(t.position).applyMatrix4(F),i.positionScreen.copy(i.position).applyMatrix4(F),c(t.positionScreen,i.positionScreen)===!0&&(t.positionScreen.multiplyScalar(1/t.positionScreen.w),i.positionScreen.multiplyScalar(1/i.positionScreen.w),v=a(),v.id=T.id,v.v1.copy(t),v.v2.copy(i),v.z=Math.max(t.positionScreen.z,i.positionScreen.z),v.renderOrder=T.renderOrder,v.material=T.material,T.material.vertexColors===THREE.VertexColors&&(v.vertexColors[0].fromArray(y,3*e),v.vertexColors[1].fromArray(y,3*r)),O.elements.push(v))}function f(e,r,t){var i=g[e],n=g[r],a=g[t];if(p(i,n,a)!==!1&&(H.side===THREE.DoubleSide||E(i,n,a)===!0)){d=o(),d.id=T.id,d.v1.copy(i),d.v2.copy(n),d.v3.copy(a),d.z=(i.positionScreen.z+n.positionScreen.z+a.positionScreen.z)/3,d.renderOrder=T.renderOrder,d.normalModel.fromArray(m,3*e),d.normalModel.applyMatrix3(w).normalize();for(var s=0;3>s;s++){var l=d.vertexNormalsModel[s];l.fromArray(m,3*arguments[s]),l.applyMatrix3(w).normalize();var c=d.uvs[s];c.fromArray(x,2*arguments[s])}d.vertexNormalsLength=3,d.material=T.material,O.elements.push(d)}}var m=[],y=[],x=[],T=null,H=null,w=new THREE.Matrix3;return{setObject:e,projectVertex:r,checkTriangleVisibility:p,checkBackfaceCulling:E,pushVertex:t,pushNormal:i,pushColor:s,pushUv:l,pushLine:h,pushTriangle:f}},q=new U;this.projectScene=function(r,i,s,p){f=0,m=0,x=0,O.elements.length=0,r.autoUpdate===!0&&r.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),B.copy(i.matrixWorldInverse.getInverse(i.matrixWorld)),A.multiplyMatrices(i.projectionMatrix,B),G.setFromMatrix(A),E=0,O.objects.length=0,O.lights.length=0,e(r),s===!0&&O.objects.sort(l);for(var u=O.objects,y=0,T=u.length;T>y;y++){var H=u[y].object,w=H.geometry;if(q.setObject(H),R=H.matrixWorld,h=0,H instanceof THREE.Mesh){if(w instanceof THREE.BufferGeometry){var S=w.attributes,M=w.groups;if(void 0===S.position)continue;for(var b=S.position.array,z=0,V=b.length;V>z;z+=3)q.pushVertex(b[z],b[z+1],b[z+2]);if(void 0!==S.normal)for(var j=S.normal.array,z=0,V=j.length;V>z;z+=3)q.pushNormal(j[z],j[z+1],j[z+2]);if(void 0!==S.uv)for(var k=S.uv.array,z=0,V=k.length;V>z;z+=2)q.pushUv(k[z],k[z+1]);if(null!==w.index){var N=w.index.array;if(M.length>0)for(var W=0;W<M.length;W++)for(var U=M[W],z=U.start,V=U.start+U.count;V>z;z+=3)q.pushTriangle(N[z],N[z+1],N[z+2]);else for(var z=0,V=N.length;V>z;z+=3)q.pushTriangle(N[z],N[z+1],N[z+2])}else for(var z=0,V=b.length/3;V>z;z+=3)q.pushTriangle(z,z+1,z+2)}else if(w instanceof THREE.Geometry){var J=w.vertices,K=w.faces,Q=w.faceVertexUvs[0];P.getNormalMatrix(R);for(var X=H.material,Y=Array.isArray(X),Z=0,$=J.length;$>Z;Z++){var _=J[Z];if(C.copy(_),X.morphTargets===!0)for(var ee=w.morphTargets,re=H.morphTargetInfluences,te=0,ie=ee.length;ie>te;te++){var ne=re[te];if(0!==ne){var oe=ee[te],ae=oe.vertices[Z];C.x+=(ae.x-_.x)*ne,C.y+=(ae.y-_.y)*ne,C.z+=(ae.z-_.z)*ne}}q.pushVertex(C.x,C.y,C.z)}for(var se=0,le=K.length;le>se;se++){var ce=K[se];if(X=Y===!0?H.material[ce.materialIndex]:H.material,void 0!==X){var pe=X.side,Ee=g[ce.a],ue=g[ce.b],he=g[ce.c];if(q.checkTriangleVisibility(Ee,ue,he)!==!1){var de=q.checkBackfaceCulling(Ee,ue,he);if(pe!==THREE.DoubleSide){if(pe===THREE.FrontSide&&de===!1)continue;if(pe===THREE.BackSide&&de===!0)continue}d=o(),d.id=H.id,d.v1.copy(Ee),d.v2.copy(ue),d.v3.copy(he),d.normalModel.copy(ce.normal),de!==!1||pe!==THREE.BackSide&&pe!==THREE.DoubleSide||d.normalModel.negate(),d.normalModel.applyMatrix3(P).normalize();for(var fe=ce.vertexNormals,ve=0,me=Math.min(fe.length,3);me>ve;ve++){var ye=d.vertexNormalsModel[ve];ye.copy(fe[ve]),de!==!1||pe!==THREE.BackSide&&pe!==THREE.DoubleSide||ye.negate(),ye.applyMatrix3(P).normalize()}d.vertexNormalsLength=fe.length;var xe=Q[se];if(void 0!==xe)for(var Re=0;3>Re;Re++)d.uvs[Re].copy(xe[Re]);d.color=ce.color,d.material=X,d.z=(Ee.positionScreen.z+ue.positionScreen.z+he.positionScreen.z)/3,d.renderOrder=H.renderOrder,O.elements.push(d)}}}}}else if(H instanceof THREE.Line){if(F.multiplyMatrices(A,R),w instanceof THREE.BufferGeometry){var S=w.attributes;if(void 0!==S.position){for(var b=S.position.array,z=0,V=b.length;V>z;z+=3)q.pushVertex(b[z],b[z+1],b[z+2]);if(void 0!==S.color)for(var Te=S.color.array,z=0,V=Te.length;V>z;z+=3)q.pushColor(Te[z],Te[z+1],Te[z+2]);if(null!==w.index)for(var N=w.index.array,z=0,V=N.length;V>z;z+=2)q.pushLine(N[z],N[z+1]);else for(var He=H instanceof THREE.LineSegments?2:1,z=0,V=b.length/3-1;V>z;z+=He)q.pushLine(z,z+1)}}else if(w instanceof THREE.Geometry){var J=H.geometry.vertices;if(0===J.length)continue;Ee=n(),Ee.positionScreen.copy(J[0]).applyMatrix4(F);for(var He=H instanceof THREE.LineSegments?2:1,Z=1,$=J.length;$>Z;Z++)Ee=n(),Ee.positionScreen.copy(J[Z]).applyMatrix4(F),(Z+1)%He>0||(ue=g[h-2],D.copy(Ee.positionScreen),I.copy(ue.positionScreen),c(D,I)===!0&&(D.multiplyScalar(1/D.w),I.multiplyScalar(1/I.w),v=a(),v.id=H.id,v.v1.positionScreen.copy(D),v.v2.positionScreen.copy(I),v.z=Math.max(D.z,I.z),v.renderOrder=H.renderOrder,v.material=H.material,H.material.vertexColors===THREE.VertexColors&&(v.vertexColors[0].copy(H.geometry.colors[Z]),v.vertexColors[1].copy(H.geometry.colors[Z-1])),O.elements.push(v)))}}else if(H instanceof THREE.Points){if(F.multiplyMatrices(A,R),w instanceof THREE.Geometry)for(var J=H.geometry.vertices,Z=0,$=J.length;$>Z;Z++){var _=J[Z];L.set(_.x,_.y,_.z,1),L.applyMatrix4(F),t(L,H,i)}}else H instanceof THREE.Sprite&&(L.set(R.elements[12],R.elements[13],R.elements[14],1),L.applyMatrix4(A),t(L,H,i))}return p===!0&&O.elements.sort(l),O}};